@using Library.DataAccess.Domain
@using Newtonsoft.Json
@using Markdig
@{
    ViewData["Title"] = "Feed";
    Layout = "~/Views/Shared/_LayoutUsers.cshtml";
    var defaultImage = "/img/esfelogo-expanded.png";
    var postImage = "";
    List<Posts> pinnedPosts = ViewBag.pinnedPosts as List<Posts>;
    List<Posts> lastPosts = ViewBag.lastPosts as List<Posts>;
}

<header>
    <link href="https://fonts.googleapis.com/css?family=Poppins:400,600,700&family=Inria+Sans&display=swap" rel="stylesheet" />
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet">
</header>

<!-- ✅ Estilos para las tarjetas más redondeadas y resaltadas -->
<style>
    .markdown-content {
        color: #000 !important;
    }

        .markdown-content p {
            margin-bottom: 0.5rem;
            color: #000;
        }

        .markdown-content strong,
        .markdown-content b {
            font-weight: 700;
            color: #000;
        }

    /* ---- Tarjetas redondeadas ---- */
    .card {
        border-radius: 20px !important;
        overflow: hidden;
        transition: all 0.25s ease-in-out;
        box-shadow: 0 4px 12px rgba(0,0,0,0.08) !important;
    }

        .card:hover {
            transform: translateY(-6px);
            box-shadow: 0 10px 18px rgba(0,0,0,0.15) !important;
        }

    .card-img-top {
        border-radius: 20px 20px 0 0 !important;
        height: 220px;
        object-fit: cover;
    }

    /* ---- Carrusel tarjetas ---- */
    .team-item {
        border-radius: 20px;
        overflow: hidden;
        transition: 0.25s ease-in-out;
        box-shadow: 0 4px 12px rgba(0,0,0,0.08);
    }

        .team-item:hover {
            transform: translateY(-6px);
            box-shadow: 0 10px 18px rgba(0,0,0,0.15);
        }

        .team-item img {
            height: 250px;
            object-fit: cover;
            border-radius: 20px 20px 0 0;
        }

        .team-item .bg-light {
            border-radius: 0 0 20px 20px;
        }
</style>

<!-- Header Start -->
<div class="jumbotron jumbotron-fluid page-header position-relative overlay-bottom" style="margin-bottom: 90px;">
    <div class="container text-center py-5">
        <h1 class="text-white display-1">Blog</h1>
        <div class="mx-auto mb-5" style="width: 100%; max-width: 600px;">
            <form asp-action="Search" method="get" class="d-flex flex-column flex-md-row align-items-center justify-content-center p-4">
                <div class="w-100">
                    <input type="text" name="Query" class="btn btn-light btn-lg px-4" id="Query" placeholder="Buscar..." />
                </div>
                <div class="d-flex flex-column flex-md-row w-100 justify-content-between">
                    <div class="w-100">
                        <button type="submit" class="btn btn-light btn-lg px-4 shadow-sm mt-1">
                            <i class="fas fa-search"></i> Buscar publicaciones
                        </button>
                    </div>
                </div>
            </form>
        </div>
    </div>
</div>
<!-- Header End -->
@if (pinnedPosts != null && pinnedPosts.Count > 0)
{
    <div class="container-fluid py-1">
        <div class="container py-1">
            <div class="section-title text-center position-relative mb-5">
                <h6 class="d-inline-block position-relative text-secondary text-uppercase pb-2">Destacadas</h6>
                <h1 class="display-5">Publicaciones Importantes</h1>
            </div>

            @if (pinnedPosts.Count > 3)
            {
                <!-- Carrusel -->
                <div class="owl-carousel team-carousel position-relative" style="padding: 0 30px;">
                    @foreach (var post in pinnedPosts)
                    {
                        postImage = post.IMAGES.Take(1).FirstOrDefault()?.PATH ?? defaultImage;
                        var htmlContent = Markdown.ToHtml(post.CONTENT ?? "");
                        <div class="team-item">
                            <a href="/Posts/Details/@post.ID" style="text-decoration:none;">
                                <img class="img-fluid w-100" src="@postImage" alt="@post.TITLE">
                                <div class="bg-light text-center p-4">
                                    <h5 class="mb-3">@post.TITLE</h5>
                                    <p class="mb-2">@post.CATEGORY.Name</p>
                                    <div class="markdown-content text-muted small" style="font-size: 17px; line-height: 1.6; font-family: 'Poppins', sans-serif;">
                                        @Html.Raw(htmlContent.Length > 200 ? htmlContent.Substring(0, 200) + "..." : htmlContent)
                                    </div>
                                </div>
                            </a>
                        </div>
                    }
                </div>
            }
            else
            {
                <!-- Tarjetas normales -->
                <div class="row">
                    @foreach (var post in pinnedPosts)
                    {
                        postImage = post.IMAGES.Take(1).FirstOrDefault()?.PATH ?? defaultImage;
                        var htmlContent = Markdown.ToHtml(post.CONTENT ?? "");
                        <div class="col-md-4 col-sm-6 mb-4">
                            <a href="/Posts/Details/@post.ID" style="text-decoration:none;">
                                <div class="card shadow-sm border-0 h-100">
                                    <img class="card-img-top" src="@postImage" alt="@post.TITLE">
                                    <div class="card-body text-center">
                                        <h5 class="card-title">@post.TITLE</h5>
                                        <p class="text-secondary">@post.CATEGORY.Name</p>
                                        <div class="markdown-content text-muted small" style="font-size: 17px; line-height: 1.6; font-family: 'Poppins', sans-serif;">
                                            @Html.Raw(htmlContent.Length > 200 ? htmlContent.Substring(0, 200) + "..." : htmlContent)
                                        </div>
                                    </div>
                                </div>
                            </a>
                        </div>
                    }
                </div>
            }
        </div>
    </div>
}

@if (lastPosts != null && lastPosts.Count > 0)
{
    <!-- Últimas Publicaciones -->
    <div class="container mt-4">
        <h2 class="fw-bold mb-3">Últimas publicaciones</h2>
        <div class="row">
            @foreach (var post in lastPosts)
            {
                postImage = post.IMAGES.Take(1).FirstOrDefault()?.PATH ?? defaultImage;
                var htmlContent = Markdown.ToHtml(post.CONTENT ?? "");
                <div class="col-md-3 col-sm-6 mb-4">
                    <a href="/Posts/Details/@post.ID" style="text-decoration:none;">
                        <div class="card shadow-sm border-0 h-100">
                            <img class="card-img-top" src="@postImage" alt="@post.TITLE">
                            <div class="card-body">
                                <p class="text-secondary mb-1">@post.CATEGORY.Name</p>
                                <h5 class="card-title">@post.TITLE</h5>
                                <div class="markdown-content card-text text-muted" style="font-size: 17px; line-height: 1.6; font-family: 'Poppins', sans-serif;">
                                    @Html.Raw(htmlContent.Length > 150 ? htmlContent.Substring(0, 150) + "..." : htmlContent)
                                </div>
                            </div>
                        </div>
                    </a>
                </div>
            }
        </div>
    </div>
}
else
{
    <h2 class="text-center fw-bold">No hay publicaciones</h2>
}

@section Scripts {
    <script src="~/lib/owlcarousel/owl.carousel.min.js"></script>
    <script>
        $(".team-carousel").owlCarousel({
            autoplay: true,
            smartSpeed: 1000,
            margin: 30,
            dots: false,
            loop: true,
            nav: true,
            navText: [
                '<i class="bi bi-chevron-left"></i>',
                '<i class="bi bi-chevron-right"></i>'
            ],
            responsive: {
                0: { items: 1 },
                576: { items: 2 },
                768: { items: 3 },
                992: { items: 4 }
            }
        });
    </script>
}